{% load static crispy_forms_tags tailwind_tags %}

<div class="flex flex-col items-center justify-center mt-6">
  <div class="card max-w-6xl bg-base-100 shadow-xl w-full">
    <div class="card-body">
      <h2 class="card-title text-xl font-bold mb-4">
        <i class="fas fa-tasks mr-2 text-primary"></i>
        Actividades Adicionales
      </h2>
      
      {% if actividades_adicionales.actividades_adicionales %}
        <!-- Spinner container -->
        <div id="spinner-container-paso3" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-base-100 bg-opacity-75">
          <div class="flex flex-col items-center">
            <span class="loading loading-spinner loading-lg text-primary"></span>
            <p class="mt-4 text-lg font-semibold">Enviando actividades...</p>
          </div>
        </div>
        
        <div class="mb-4">
          <p class="text-base-content/70 mb-4">
            Seleccione las actividades adicionales que desea incluir en la especificación técnica:
          </p>
          
          <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
              <thead>
                <tr>
                  <th class="w-12">
                    <input type="checkbox" id="select-all-actividades" class="checkbox checkbox-primary">
                  </th>
                  <th class="w-1/5">Actividad</th>
                  <th class="w-1/4">Valor Recomendado</th>
                  <th class="w-1/6">Unidad</th>
                  <th class="w-2/5">Descripción</th>
                </tr>
              </thead>
              <tbody id="actividades-table-body">
                {% for actividad in actividades_adicionales.actividades_adicionales %}
                  <tr class="actividad-row" data-index="{{ forloop.counter0 }}">
                    <td>
                      <input 
                        type="checkbox" 
                        class="checkbox checkbox-primary actividad-checkbox" 
                        data-nombre='{{ actividad.nombre|escapejs }}'
                        data-valor='{{ actividad.valor_recomendado|escapejs }}'
                        data-unidad='{{ actividad.unidad_medida|escapejs }}'
                        data-descripcion='{{ actividad.descripcion|escapejs }}'
                        id="actividad-{{ forloop.counter0 }}"
                        {% if actividad.check %}checked{% endif %}
                      >
                    </td>
                    <td class="font-semibold">{{ actividad.nombre }}</td>
                    <td>
                      <input 
                        type="text" 
                        class="input input-bordered input-sm w-full valor-recomendado-input" 
                        value="{{ actividad.valor_recomendado }}"
                        data-original-value="{{ actividad.valor_recomendado }}"
                      >
                    </td>
                    <td class="text-sm">{{ actividad.unidad_medida }}</td>
                    <td class="text-sm text-base-content/70 leading-tight" style="max-width: 300px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.2;">{{ actividad.descripcion }}</td>
                  </tr>
                {% endfor %}
                <!-- Fila para agregar nueva actividad -->
                <tr id="nuevo-actividad-row" class="bg-base-200">
                  <td>
                    <button class="btn btn-sm btn-success" id="agregar-actividad-btn" title="Agregar actividad">
                      <i class="fas fa-plus"></i>
                    </button>
                  </td>
                  <td>
                    <input 
                      type="text" 
                      class="input input-bordered input-sm w-full" 
                      id="nuevo-actividad-nombre"
                      placeholder="Nombre de la actividad"
                    >
                  </td>
                  <td>
                    <input 
                      type="text" 
                      class="input input-bordered input-sm w-full" 
                      id="nuevo-actividad-valor"
                      placeholder="Valor recomendado"
                    >
                  </td>
                  <td>
                    <input 
                      type="text" 
                      class="input input-bordered input-sm w-full" 
                      id="nuevo-actividad-unidad"
                      placeholder="Unidad"
                    >
                  </td>
                  <td>
                    <input 
                      type="text" 
                      class="input input-bordered input-sm w-full" 
                      id="nuevo-actividad-descripcion"
                      placeholder="Descripción (opcional)"
                    >
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="mt-6 flex justify-end items-center">
            <button class="btn btn-primary" id="enviar-actividades-btn">
              <i class="fas fa-arrow-right mr-2"></i>
              Continuar
            </button>
          </div>
        </div>
      {% else %}
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          <span>No hay actividades adicionales disponibles. Por favor, complete los pasos anteriores primero.</span>
        </div>
        <div class="card-actions justify-end mt-6">
          <button class="btn btn-outline" onclick="window.location.href='{% url 'n8n:pasos' %}?paso=2'">
            <i class="fas fa-arrow-left mr-2"></i>
            Volver al Paso 2
          </button>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const selectAllCheckbox = document.getElementById('select-all-actividades');
  let actividadesCheckboxes = document.querySelectorAll('.actividad-checkbox');
  const enviarBtn = document.getElementById('enviar-actividades-btn');
  
  // Manejar seleccionar/deseleccionar todos
  if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
      const allCheckboxes = document.querySelectorAll('.actividad-checkbox');
      allCheckboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
      updateEnviarButton();
    });
  }
  
  // Manejar cambios en checkboxes individuales
  actividadesCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      // Actualizar el estado de "seleccionar todos"
      if (selectAllCheckbox) {
        const allCheckboxes = document.querySelectorAll('.actividad-checkbox');
        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked && !allChecked;
      }
      updateEnviarButton();
    });
  });
  
  // Actualizar estado del botón de enviar
  function updateEnviarButton() {
    // Obtener todos los checkboxes actualizados
    const allCheckboxes = document.querySelectorAll('.actividad-checkbox');
    const selectedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
    if (enviarBtn) {
      enviarBtn.disabled = selectedCount === 0;
      enviarBtn.innerHTML = `<i class="fas fa-arrow-right mr-2"></i> Continuar`;
    }
  }
  
  // Manejar agregar nueva actividad
  const agregarActividadBtn = document.getElementById('agregar-actividad-btn');
  const nuevoActividadNombre = document.getElementById('nuevo-actividad-nombre');
  const nuevoActividadValor = document.getElementById('nuevo-actividad-valor');
  const nuevoActividadUnidad = document.getElementById('nuevo-actividad-unidad');
  const nuevoActividadDescripcion = document.getElementById('nuevo-actividad-descripcion');
  const nuevoActividadRow = document.getElementById('nuevo-actividad-row');
  const actividadesTableBody = document.getElementById('actividades-table-body');
  
  if (agregarActividadBtn) {
    agregarActividadBtn.addEventListener('click', function() {
      const nombre = nuevoActividadNombre.value.trim();
      const valor = nuevoActividadValor.value.trim();
      const unidad = nuevoActividadUnidad.value.trim();
      const descripcion = nuevoActividadDescripcion.value.trim();
      
      if (!nombre || !valor || !unidad) {
        alert('Por favor, complete al menos el nombre, valor y unidad de la actividad');
        return;
      }
      
      // Crear nueva fila
      const newRow = document.createElement('tr');
      newRow.className = 'actividad-row nuevo-actividad-row';
      const index = actividadesCheckboxes.length;
      
      newRow.innerHTML = `
        <td>
          <input 
            type="checkbox" 
            class="checkbox checkbox-primary actividad-checkbox" 
            data-nombre="${nombre}"
            data-valor="${valor}"
            data-unidad="${unidad}"
            data-descripcion="${descripcion}"
            id="actividad-${index}"
            checked
          >
        </td>
        <td class="font-semibold">${nombre}</td>
        <td>
          <input 
            type="text" 
            class="input input-bordered input-sm w-full valor-recomendado-input" 
            value="${valor}"
            data-original-value="${valor}"
          >
        </td>
        <td class="text-sm">${unidad}</td>
        <td class="text-sm text-base-content/70 leading-tight" style="max-width: 300px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.2;">${descripcion || ''}</td>
      `;
      
      // Insertar antes de la fila de nueva actividad
      actividadesTableBody.insertBefore(newRow, nuevoActividadRow);
      
      // Limpiar campos
      nuevoActividadNombre.value = '';
      nuevoActividadValor.value = '';
      nuevoActividadUnidad.value = '';
      nuevoActividadDescripcion.value = '';
      
      // Re-inicializar eventos para el nuevo checkbox
      const newCheckbox = newRow.querySelector('.actividad-checkbox');
      newCheckbox.addEventListener('change', function() {
        if (selectAllCheckbox) {
          const allCheckboxes = document.querySelectorAll('.actividad-checkbox');
          const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
          const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);
          selectAllCheckbox.checked = allChecked;
          selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
        updateEnviarButton();
      });
      
      // Actualizar lista de checkboxes
      actividadesCheckboxes = document.querySelectorAll('.actividad-checkbox');
      
      // Actualizar estado de "seleccionar todos" y botón
      if (selectAllCheckbox) {
        const allCheckboxes = document.querySelectorAll('.actividad-checkbox');
        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked && !allChecked;
      }
      updateEnviarButton();
    });
  }
  
  // Permitir agregar actividad con Enter
  if (nuevoActividadNombre) {
    nuevoActividadNombre.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        agregarActividadBtn.click();
      }
    });
  }
  if (nuevoActividadValor) {
    nuevoActividadValor.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        agregarActividadBtn.click();
      }
    });
  }
  if (nuevoActividadUnidad) {
    nuevoActividadUnidad.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        agregarActividadBtn.click();
      }
    });
  }
  if (nuevoActividadDescripcion) {
    nuevoActividadDescripcion.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        agregarActividadBtn.click();
      }
    });
  }
  
  // Manejar envío de actividades seleccionadas
  if (enviarBtn) {
    enviarBtn.addEventListener('click', async function() {
      const selectedActividades = [];
      
      // Obtener todos los checkboxes (incluyendo los nuevos)
      const allCheckboxes = document.querySelectorAll('.actividad-checkbox');
      
      allCheckboxes.forEach(checkbox => {
        if (checkbox.checked) {
          // Obtener el valor actualizado del input de valor recomendado
          const row = checkbox.closest('tr');
          const valorInput = row.querySelector('.valor-recomendado-input');
          const valorActualizado = valorInput ? valorInput.value : checkbox.getAttribute('data-valor');
          
          const actividadData = {
            nombre: checkbox.getAttribute('data-nombre'),
            valor_recomendado: valorActualizado,
            unidad_medida: checkbox.getAttribute('data-unidad'),
            descripcion: checkbox.getAttribute('data-descripcion')
          };
          selectedActividades.push(actividadData);
        }
      });
      
      if (selectedActividades.length === 0) {
        alert('Por favor, seleccione al menos una actividad');
        return;
      }
      
      // Mostrar spinner
      const spinnerContainer = document.getElementById('spinner-container-paso3');
      if (spinnerContainer) {
        spinnerContainer.classList.remove('hidden');
      }
      
      // Deshabilitar botón
      enviarBtn.disabled = true;
      const originalText = enviarBtn.innerHTML;
      enviarBtn.innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span> Enviando...';
      
      try {
        const response = await fetch('{% url "n8n:enviar_actividades" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            actividades: selectedActividades
          })
        });
        
        const result = await response.json();
        
        // Ocultar spinner
        if (spinnerContainer) {
          spinnerContainer.classList.add('hidden');
        }
        
        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Error al enviar las actividades');
        }
        
        // Mostrar éxito y redirigir o continuar según la respuesta
        alert('Actividades enviadas exitosamente');
        console.log('Respuesta:', result.response_data);
        
      } catch (error) {
        console.error('Error:', error);
        
        // Ocultar spinner
        if (spinnerContainer) {
          spinnerContainer.classList.add('hidden');
        }
        
        alert('Hubo un error al enviar las actividades: ' + error.message);
      } finally {
        // Restaurar botón
        enviarBtn.disabled = false;
        enviarBtn.innerHTML = originalText;
      }
    });
  }
  
  // Inicializar estado del botón y "seleccionar todos"
  updateEnviarButton();
  
  // Inicializar estado de "seleccionar todos" basado en checkboxes existentes
  if (selectAllCheckbox) {
    const allCheckboxes = document.querySelectorAll('.actividad-checkbox');
    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
    const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);
    selectAllCheckbox.checked = allChecked;
    selectAllCheckbox.indeterminate = someChecked && !allChecked;
  }
});
</script>

