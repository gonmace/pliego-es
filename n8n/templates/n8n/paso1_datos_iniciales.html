{% extends 'n8n/pasos.html' %}
{% load static crispy_forms_tags tailwind_tags %}

{% block content %}
  {{ block.super }}
  
  <!-- Contenido del Paso 1 -->
  <div class="flex flex-col items-center">
    <!-- Spinner container -->
    <div id="spinner-container" class="hidden flex flex-col items-center justify-center mt-12 mb-8">
      <span class="loading loading-spinner loading-lg text-primary"></span>
      <p class="mt-4 text-lg font-semibold text-primary">
        Generando parámetros técnicos...
      </p>
      <div class="flex gap-2 mt-4">
        <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0s;"></div>
        <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
        <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
      </div>
    </div>
    
    <!-- Contenedor para mostrar el resultado del markdown -->
    <div id="resultado-markdown-container" class="hidden w-full max-w-5xl mt-8">
      <div class="card bg-base-100 shadow-2xl w-full">
        <div class="card-body p-8">
          <div class="mb-6">
            <h2 class="card-title text-2xl mb-2">
              <div class="flex items-center gap-4">
                <div class="badge badge-success badge-lg w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg">
                  <i class="fas fa-check"></i>
                </div>
                <span class="text-success">
                  <i class="fas fa-file-alt mr-2"></i>
                  Especificación Técnica Generada
                </span>
              </div>
            </h2>
          </div>
          
          <div id="resultado-markdown-content" class="prose prose-slate prose-lg max-w-none">
            <!-- El contenido markdown se insertará aquí -->
          </div>
          
          <div class="card-actions justify-end mt-6 pt-6 border-t border-base-300">
            <button onclick="window.location.reload()" class="btn btn-outline">
              <i class="fas fa-redo mr-2"></i>
              Generar Nueva
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido según el paso -->
    {% if respuesta_completa.output and respuesta_completa.output.parametros %}
      <!-- Si hay parámetros, se mostrarán en el modal del paso 2 -->
    {% else %}
      <!-- Si no hay parámetros, mostrar formulario de título y descripción -->
      <div class="flex flex-col items-center justify-center mt-8 w-full max-w-5xl">
        <div class="card bg-base-100 shadow-2xl w-full hover:shadow-3xl transition-shadow">
          <div class="card-body p-8">
            <div class="mb-6">
              <h2 class="card-title text-2xl mb-2">
                <div class="flex items-center gap-4">
                  <div class="badge badge-primary badge-lg w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg animate-pulse-glow">
                    1
                  </div>
                  <span class="text-primary">
                    <i class="fas fa-database mr-2"></i>
                    Datos Iniciales
                  </span>
                </div>
              </h2>
              <p class="text-sm text-base-content/60 ml-14">Complete los datos para generar la especificación técnica</p>
            </div>
            
            <div class="space-y-4">
              <!-- Mensaje de razón si hay incoherencia -->
              <div id="razon-alert" class="alert alert-warning mb-4 hidden">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <div>
                  <div class="font-semibold mb-1">Razón de incoherencia:</div>
                  <div id="razon-text"></div>
                </div>
              </div>
              
              {% if datos_paso1.pregunta %}
                <div class="alert alert-warning mb-4">
                  <i class="fas fa-exclamation-triangle mr-2"></i>
                  <div>
                    <div>{{ datos_paso1.pregunta }}</div>
                  </div>
                </div>
              {% endif %}
              
              <form id="datos-generales-form" class="space-y-6">
                <!-- Título y Tipo de Servicio en una fila -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Título -->
                  <div class="form-control w-full">
                    <label class="label" for="titulo">
                      <span class="label-text font-semibold flex items-center gap-2">
                        <i class="fas fa-heading text-primary"></i>
                        Título
                      </span>
                      <span class="label-text-alt text-error font-bold">*</span>
                    </label>
                    <input 
                      type="text" 
                      name="titulo" 
                      id="titulo"
                      class="input input-bordered input-primary w-full focus:input-primary" 
                      placeholder="Ingrese el título"
                      value="{{ datos_paso1.titulo|default:'' }}"
                      required
                    >
                    <label class="label hidden" id="titulo-error-label">
                      <span class="label-text-alt text-error" id="titulo-error"></span>
                    </label>
                  </div>
                  
                  <!-- Tipo de Servicio -->
                  <div class="form-control w-full">
                    <label class="label" for="tipo_servicio">
                      <span class="label-text font-semibold flex items-center gap-2">
                        <i class="fas fa-cogs text-primary"></i>
                        Tipo de Servicio
                      </span>
                      <span class="label-text-alt text-error font-bold">*</span>
                    </label>
                    <select 
                      name="tipo_servicio" 
                      id="tipo_servicio"
                      class="select select-bordered select-primary w-full focus:select-primary" 
                      required
                    >
                      <option value="">Seleccione un tipo de servicio</option>
                      <option value="Mecánico" {% if datos_paso1.tipo_servicio == "Mecánico" %}selected{% endif %}>Mecánico</option>
                      <option value="Eléctrico" {% if datos_paso1.tipo_servicio == "Eléctrico" %}selected{% endif %}>Eléctrico</option>
                      <option value="Instrumentación" {% if datos_paso1.tipo_servicio == "Instrumentación" %}selected{% endif %}>Instrumentación</option>
                      <option value="SSMA (Seguridad, Salud y Medio Ambiente)" {% if datos_paso1.tipo_servicio == "SSMA (Seguridad, Salud y Medio Ambiente)" %}selected{% endif %}>SSMA (Seguridad, Salud y Medio Ambiente)</option>
                      <option value="Infraestructura / Obras Civiles" {% if datos_paso1.tipo_servicio == "Infraestructura / Obras Civiles (OOCC)" %}selected{% endif %}>Infraestructura / Obras Civiles (OOCC)</option>
                      <option value="Mantenimiento de Vehículos" {% if datos_paso1.tipo_servicio == "Mantenimiento de Vehículos" %}selected{% endif %}>Mantenimiento de Vehículos</option>
                      <option value="Laboratorio y Aseguramiento de la Calidad" {% if datos_paso1.tipo_servicio == "Laboratorio y Aseguramiento de la Calidad" %}selected{% endif %}>Laboratorio y Aseguramiento de la Calidad</option>
                      <option value="Logística y Distribución" {% if datos_paso1.tipo_servicio == "Logística y Distribución" %}selected{% endif %}>Logística y Distribución</option>
                    </select>
                    <label class="label hidden" id="tipo-servicio-error-label">
                      <span class="label-text-alt text-error" id="tipo-servicio-error"></span>
                    </label>
                  </div>
                </div>

                <!-- Descripción -->
                <div class="form-control w-full">
                  <label class="label" for="descripcion">
                    <span class="label-text font-semibold flex items-center gap-2">
                      <i class="fas fa-align-left text-primary"></i>
                      Descripción
                    </span>
                    <span class="label-text-alt text-error font-bold">*</span>
                  </label>
                  <textarea 
                    name="descripcion" 
                    id="descripcion"
                    class="textarea textarea-bordered textarea-primary w-full focus:textarea-primary" 
                    rows="3"
                    placeholder="Ingrese la descripción detallada..."
                    required
                  >{{ datos_paso1.descripcion|default:'' }}</textarea>
                  <label class="label hidden" id="descripcion-error-label">
                    <span class="label-text-alt text-error" id="descripcion-error"></span>
                  </label>
                </div>

                <!-- Botón de acción -->
                <div class="flex justify-end mt-8 pt-6 border-t border-base-300">
                  <button type="button" id="btn-continuar-datos" class="btn btn-primary">
                    <span class="normal-text flex items-center gap-2">
                      <i class="fas fa-arrow-right"></i>
                      Continuar
                    </span>
                    <span class="loading loading-spinner loading-sm hidden"></span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Modales -->
  <dialog id="modal-enviar-especificacion" class="modal fixed inset-0 z-50 flex items-start justify-center pt-16">
    <div class="modal-box max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-2xl font-bold">
          <i class="fas fa-paper-plane mr-2 text-primary"></i>
          Enviar Especificación Técnica
        </h3>
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost">✕</button>
        </form>
      </div>
      <div class="divider my-4"></div>
      
      <div class="mb-4">
        <div class="alert alert-info mb-4">
          <i class="fas fa-info-circle mr-2"></i>
          <span>Se enviarán los datos ingresados en el paso anterior a la API de n8n.</span>
        </div>
        
        <div class="bg-base-200 rounded-lg p-4 mb-4">
          <h4 class="font-semibold mb-2">Datos a enviar:</h4>
          <p><strong>Título:</strong> <span id="modal-titulo-preview"></span></p>
          <p><strong>Descripción:</strong> <span id="modal-descripcion-preview"></span></p>
        </div>
        
        <div id="modal-loading" class="hidden text-center py-4">
          <span class="loading loading-spinner loading-lg"></span>
          <p class="mt-2">Enviando datos y esperando respuesta...</p>
        </div>
        
        <div id="modal-response" class="hidden">
          <div class="alert alert-success mb-4">
            <i class="fas fa-check-circle mr-2"></i>
            <span>Respuesta recibida exitosamente</span>
          </div>
          <div class="bg-base-200 rounded-lg p-4 overflow-x-auto max-h-96">
            <pre id="modal-response-content" class="text-sm font-mono whitespace-pre text-left"></pre>
          </div>
        </div>
        
        <div id="modal-error" class="hidden">
          <div class="alert alert-error mb-4">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="modal-error-message"></span>
          </div>
        </div>
      </div>
      
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-outline" id="modal-cancel-btn">Cancelar</button>
        </form>
        <button class="btn btn-primary" id="modal-enviar-btn">
          <i class="fas fa-paper-plane mr-2"></i>
          <span id="btn-enviar-text">Enviar a API</span>
          <span id="btn-enviar-loading" class="hidden">
            <span class="loading loading-spinner loading-sm mr-2"></span>
            Enviando...
          </span>
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>Cerrar</button>
    </form>
  </dialog>

  <!-- Paso 3: Ajustar Título -->
  {% include 'n8n/pasos/paso3_titulo.html' %}

  <dialog id="modal-respuesta-json" class="modal fixed inset-0 z-50 flex items-start justify-center pt-16">
    <div class="modal-box max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-2xl font-bold">
          <i class="fas fa-code mr-2 text-primary"></i>
          Respuesta del Servidor
        </h3>
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost">✕</button>
        </form>
      </div>
      <div class="divider my-4"></div>
      
      <div class="mb-4">
        <div class="bg-base-200 rounded-lg p-4 overflow-x-auto max-h-96">
          <pre id="modal-respuesta-json-content" class="text-sm font-mono whitespace-pre text-left"></pre>
        </div>
      </div>
      
      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-primary" id="modal-respuesta-json-cerrar">
            <i class="fas fa-times mr-2"></i>
            Cerrar
          </button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>Cerrar</button>
    </form>
  </dialog>

  <!-- Paso 2: Parámetros Técnicos -->
  {% include 'n8n/pasos/paso2_parametros.html' %}

  <!-- Paso 4: Actividades Adicionales -->
  {% include 'n8n/pasos/paso4_actividades.html' %}
{% endblock %}

{% block js %}
{{ block.super }}
<script>
(function() {
  'use strict';
  
  console.log('Script de paso1_datos_iniciales cargado');
  
  // Usar delegación de eventos en el documento para asegurar que funcione
  document.addEventListener('click', async function(e) {
    // Verificar si el click fue en el botón o en sus hijos
    const btn = e.target.closest('#btn-continuar-datos');
    if (!btn) return;
    
    console.log('BOTÓN CLICKEADO - Event listener funcionando!');
    
  e.preventDefault();
    e.stopPropagation();
    
    const form = document.getElementById('datos-generales-form');
    const submitBtn = document.getElementById('btn-continuar-datos');
    const normalText = submitBtn ? submitBtn.querySelector('.normal-text') : null;
    const loadingSpinner = submitBtn ? submitBtn.querySelector('.loading-spinner') : null;
    
    // Buscar los inputs dentro del formulario específico usando name
    // IMPORTANTE: Buscar solo dentro del formulario visible, no en modales ocultos
    const tituloInput = form ? form.querySelector('input[name="titulo"]') : null;
    const descripcionInput = form ? form.querySelector('textarea[name="descripcion"]') : null;
    const tipoServicioInput = form ? form.querySelector('select[name="tipo_servicio"]') : null;
    
    // Si no se encuentran en el form, buscar solo elementos visibles (no en modales ocultos)
    const tituloInputFinal = tituloInput || Array.from(document.querySelectorAll('input[name="titulo"]')).find(el => {
      const modal = el.closest('dialog');
      return !modal || modal.hasAttribute('open') || !modal.classList.contains('modal');
    });
    
    const descripcionInputFinal = descripcionInput || Array.from(document.querySelectorAll('textarea[name="descripcion"]')).find(el => {
      const modal = el.closest('dialog');
      return !modal || modal.hasAttribute('open') || !modal.classList.contains('modal');
    });
    
    const tipoServicioInputFinal = tipoServicioInput || Array.from(document.querySelectorAll('select[name="tipo_servicio"]')).find(el => {
      const modal = el.closest('dialog');
      return !modal || modal.hasAttribute('open') || !modal.classList.contains('modal');
    });
    
    console.log('Elementos encontrados:', {
      form: !!form,
      submitBtn: !!submitBtn,
      normalText: !!normalText,
      loadingSpinner: !!loadingSpinner,
      tituloInput: !!tituloInputFinal,
      descripcionInput: !!descripcionInputFinal,
      tipoServicioInput: !!tipoServicioInputFinal
    });
    
    console.log('Detalles de inputs FINALES:', {
      tituloInput: tituloInputFinal,
      tituloInputType: tituloInputFinal ? tituloInputFinal.tagName : 'null',
      tituloInputName: tituloInputFinal ? tituloInputFinal.name : 'null',
      tituloInputValue: tituloInputFinal ? tituloInputFinal.value : 'null',
      tituloInputValueLength: tituloInputFinal ? tituloInputFinal.value.length : 0,
      tituloInputVisible: tituloInputFinal ? tituloInputFinal.offsetParent !== null : false,
      descripcionInputValue: descripcionInputFinal ? descripcionInputFinal.value : 'null',
      tipoServicioInputValue: tipoServicioInputFinal ? tipoServicioInputFinal.value : 'null',
      tipoServicioSelectedIndex: tipoServicioInputFinal ? tipoServicioInputFinal.selectedIndex : 'null'
    });
  
  // Ocultar errores anteriores
    const tituloErrorLabel = document.getElementById('titulo-error-label');
    const descripcionErrorLabel = document.getElementById('descripcion-error-label');
    const tipoServicioErrorLabel = document.getElementById('tipo-servicio-error-label');
    
    if (tituloErrorLabel) tituloErrorLabel.classList.add('hidden');
    if (descripcionErrorLabel) descripcionErrorLabel.classList.add('hidden');
    if (tipoServicioErrorLabel) tipoServicioErrorLabel.classList.add('hidden');
  
  try {
    // Mostrar loading
      if (normalText) normalText.classList.add('hidden');
      if (loadingSpinner) loadingSpinner.classList.remove('hidden');
      if (submitBtn) submitBtn.disabled = true;
      
      // Validar campos - obtener valores directamente de los inputs encontrados
      const titulo = tituloInputFinal ? (tituloInputFinal.value || '').trim() : '';
      const descripcion = descripcionInputFinal ? (descripcionInputFinal.value || '').trim() : '';
      const tipoServicio = tipoServicioInputFinal ? (tipoServicioInputFinal.value || '').trim() : '';
      
      console.log('Valores obtenidos después de trim:', {
        titulo: titulo,
        descripcion: descripcion,
        tipoServicio: tipoServicio,
        tituloLength: titulo.length,
        descripcionLength: descripcion.length,
        tipoServicioLength: tipoServicio.length
      });
      
      if (!titulo || titulo.length === 0) {
        const tituloError = document.getElementById('titulo-error');
        const tituloErrorLabel = document.getElementById('titulo-error-label');
        if (tituloError) tituloError.textContent = 'El título es requerido';
        if (tituloErrorLabel) tituloErrorLabel.classList.remove('hidden');
      throw new Error('Título requerido');
    }
      
      if (!tipoServicio) {
        const tipoServicioError = document.getElementById('tipo-servicio-error');
        const tipoServicioErrorLabel = document.getElementById('tipo-servicio-error-label');
        if (tipoServicioError) tipoServicioError.textContent = 'El tipo de servicio es requerido';
        if (tipoServicioErrorLabel) tipoServicioErrorLabel.classList.remove('hidden');
        throw new Error('Tipo de servicio requerido');
    }
    
    if (!descripcion) {
        const descripcionError = document.getElementById('descripcion-error');
        const descripcionErrorLabel = document.getElementById('descripcion-error-label');
        if (descripcionError) descripcionError.textContent = 'La descripción es requerida';
        if (descripcionErrorLabel) descripcionErrorLabel.classList.remove('hidden');
      throw new Error('Descripción requerida');
    }
    
      // Guardar título, descripción y tipo de servicio en variables JavaScript para usarlas después
      window.n8nTitulo = titulo;
      window.n8nDescripcion = descripcion;
      window.n8nTipoServicio = tipoServicio;
      
      // Obtener sessionID (si está disponible)
      const sessionID = '{{ request.session.session_key|default:"" }}';
      
      // Ocultar el contenedor de "Datos Iniciales" cuando se presiona Continuar
      const formCardContainer = document.querySelector('.flex.flex-col.items-center.justify-center.mt-8');
      if (formCardContainer) {
        formCardContainer.style.display = 'none';
      }
      
      // Obtener referencia al spinner container y mostrarlo
    const spinnerContainer = document.getElementById('spinner-container');
      const spinnerText = spinnerContainer ? spinnerContainer.querySelector('p') : null;
      
      if (spinnerContainer) {
        spinnerContainer.classList.remove('hidden');
        if (spinnerText) {
          spinnerText.textContent = 'Generando parámetros técnicos...';
        }
      }
      
      // Enviar a la vista Django que guardará en el modelo y luego enviará a la API
      try {
        console.log('Enviando datos a la vista Django (que guardará en modelo y enviará a API):', {
          titulo: titulo,
          descripcion: descripcion,
          tipo_servicio: tipoServicio,
          sessionID: sessionID
        });
        
        // Función para obtener cookie CSRF
        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
          return cookieValue;
        }
        
        // Crear AbortController para timeout de 2 minutos (120 segundos)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000); // 120000 ms = 2 minutos
        
        let apiResponse;
        try {
          // Usar la vista Django que guardará en el modelo antes de enviar a la API
          const urlEnviarEspecificacion = window.n8nUrls?.enviarEspecificacion || '/n8n/enviar-especificacion/';
          apiResponse = await fetch(urlEnviarEspecificacion, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        titulo: titulo,
              descripcion: descripcion,
              tipo_servicio: tipoServicio,
              sessionID: sessionID
            }),
            signal: controller.signal
          });
          clearTimeout(timeoutId);
        } catch (error) {
          clearTimeout(timeoutId);
          if (error.name === 'AbortError') {
            throw new Error('La solicitud tardó más de 2 minutos. Por favor, intente nuevamente.');
          }
          throw error;
        }
        
          if (!apiResponse.ok) {
          let errorData;
          try {
            errorData = await apiResponse.json();
          } catch (e) {
            // Si no es JSON, intentar leer como texto
            const errorText = await apiResponse.text();
            errorData = { error: errorText };
          }
          console.error('Error en respuesta:', errorData);
          throw new Error(errorData.error || errorData.message || `Error HTTP: ${apiResponse.status}`);
        }
        
        const djangoResponse = await apiResponse.json();
        console.log('Respuesta de Django:', djangoResponse);
        
        // Mostrar el ID del registro guardado en EspecificacionTecnica
        if (djangoResponse.especificacion_id) {
          console.log('✅ EspecificacionTecnica guardada con ID:', djangoResponse.especificacion_id);
          
          // Guardar el ID en una variable global para acceso futuro
          window.especificacionTecnicaId = djangoResponse.especificacion_id;
          
          // Guardar también en sessionStorage para que persista entre recargas
          sessionStorage.setItem('especificacionTecnicaId', djangoResponse.especificacion_id);
          
          // Mostrar el ID en el breadcrumbs
          const idDisplay = document.getElementById('especificacion-id-display');
          const idValue = document.getElementById('especificacion-id-value');
          if (idDisplay && idValue) {
            idValue.textContent = djangoResponse.especificacion_id;
            idDisplay.classList.remove('hidden');
          }
        }
        
        // La vista Django devuelve la respuesta de la API en 'response_data' como objeto JSON
        let apiResult = djangoResponse.response_data || djangoResponse;
        
        console.log('Resultado de la API procesado:', apiResult);
        
        // Ocultar spinner
        if (spinnerContainer) spinnerContainer.classList.add('hidden');
        
        // PRIMERO: Verificar si la respuesta es un array con formato de coherencia
        let coherente = true;
        let razon = null;
        
        // Verificar formato de array
        if (Array.isArray(apiResult) && apiResult.length > 0) {
          const firstItem = apiResult[0];
          if (firstItem.content && Array.isArray(firstItem.content) && firstItem.content.length > 0) {
            const textContent = firstItem.content[0].text;
            if (textContent && typeof textContent.coherente === 'boolean') {
              coherente = textContent.coherente;
              razon = textContent.razon || null;
            }
          }
        }
        // Verificar formato de objeto directo con coherente
        else if (apiResult && typeof apiResult.coherente === 'boolean') {
          coherente = apiResult.coherente;
          razon = apiResult.razon || apiResult.observacion || null;
        }
        
        console.log('Análisis de coherencia:', {
          coherente: coherente,
          razon: razon,
          apiResult: apiResult,
          isArray: Array.isArray(apiResult),
          hasCoherente: apiResult && typeof apiResult.coherente !== 'undefined'
        });
        
        // Si no es coherente, mostrar el formulario nuevamente con la razón y SALIR
        if (!coherente && razon) {
          console.log('No es coherente, mostrando formulario con razón');
          
          // Ocultar spinner
          if (spinnerContainer) spinnerContainer.classList.add('hidden');
          
          // Mostrar el formulario nuevamente usando la función de observación
          // Crear un objeto con la estructura esperada
          const apiResultConObservacion = {
            observacion: razon,
            titulo: apiResult.titulo || titulo,
            descripcion: apiResult.descripcion || descripcion
          };
          
          mostrarFormularioConObservacion(apiResultConObservacion, apiResultConObservacion.titulo, apiResultConObservacion.descripcion, tipoServicio);
          
          // IMPORTANTE: Salir aquí para evitar cualquier recarga o redirección
          return;
        }
        
        // Si llegamos aquí, es coherente o no tiene formato de coherencia
        // Verificar si requiere respuesta o hay observación (formato anterior)
        if (apiResult.requiere_respuesta || apiResult.observacion) {
          // Si requiere respuesta o hay observación, mostrar el formulario con los datos prellenados
          mostrarFormularioConObservacion(apiResult, titulo, descripcion, tipoServicio);
          return;
        }
        
        // Verificar nueva estructura: array con body.parametros
        let parametrosData = null;
        if (Array.isArray(apiResult) && apiResult.length > 0 && apiResult[0].body && apiResult[0].body.parametros) {
          parametrosData = {
            parametros: apiResult[0].body.parametros,
            actividad: null // No hay actividad en esta estructura
          };
        } else if (apiResult.body && apiResult.body.parametros) {
          // Formato: objeto directo con body.parametros
          parametrosData = {
            parametros: apiResult.body.parametros,
            actividad: null
          };
        } else if (apiResult.output && apiResult.output.parametros) {
          // Formato anterior: output.parametros
          parametrosData = apiResult.output;
        }
        
        console.log('Verificando parámetros:', {
          tieneParametros: !!(parametrosData && parametrosData.parametros),
          parametrosData: parametrosData,
          estructura: Array.isArray(apiResult) ? 'array' : 'objeto',
          tieneBody: !!(apiResult.body),
          tieneOutput: !!(apiResult.output)
        });
        
        if (parametrosData && parametrosData.parametros && parametrosData.parametros.length > 0) {
          // Si tiene parámetros, renderizar la tabla dinámicamente sin recargar
          console.log('Renderizando tabla de parámetros con', parametrosData.parametros.length, 'parámetros');
          renderizarTablaParametros(parametrosData, titulo, descripcion, tipoServicio);
          return;
        } else {
          // Para otros tipos de respuestas, mostrar modal con JSON
          console.log('Respuesta recibida (sin parámetros detectados):', apiResult);
          mostrarModalJSON(apiResult);
        }
    } catch (error) {
      console.error('Error:', error);
      
      // Ocultar spinner
      if (spinnerContainer) spinnerContainer.classList.add('hidden');
      
      // Restaurar el formulario (habilitarlo nuevamente)
      if (form) {
        form.style.opacity = '1';
        form.style.pointerEvents = 'auto';
      }
      
      // Habilitar todos los inputs del formulario
      const allInputs = form ? form.querySelectorAll('input, textarea, select, button') : [];
      allInputs.forEach(input => {
        input.disabled = false;
      });
      
      alert('Hubo un error: ' + error.message);
    } finally {
      // Restaurar el botón
      if (normalText) normalText.classList.remove('hidden');
      if (loadingSpinner) loadingSpinner.classList.add('hidden');
      if (submitBtn) submitBtn.disabled = false;
    }
  } catch (error) {
    // Manejo de errores del bloque try externo
    console.error('Error en el event listener:', error);
    alert('Hubo un error: ' + error.message);
  }
  });
  
  console.log('Delegación de eventos configurada para btn-continuar-datos');
})();

// Función global para mostrar modal con JSON
function mostrarModalJSON(data) {
  // Intentar encontrar modal existente primero
  let modalRespuestaJson = document.getElementById('modal-respuesta-json');
  let modalRespuestaJsonContent = document.getElementById('modal-respuesta-json-content');
  
  // Si no existe, crearlo
  if (!modalRespuestaJson) {
    console.log('Creando modal dinámicamente');
    const modalDiv = document.createElement('dialog');
    modalDiv.id = 'modal-respuesta-json';
    modalDiv.className = 'modal fixed inset-0 z-50 flex items-start justify-center pt-16';
    
    modalDiv.innerHTML = `
      <div class="modal-box max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-2xl font-bold">
            <i class="fas fa-code mr-2 text-primary"></i>
            Respuesta del Servidor
          </h3>
          <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost">✕</button>
          </form>
        </div>
        <div class="divider my-4"></div>
        
        <div class="mb-4">
          <div class="bg-base-200 rounded-lg p-4 overflow-x-auto max-h-96">
            <pre id="modal-respuesta-json-content" class="text-sm font-mono whitespace-pre text-left"></pre>
          </div>
        </div>
        
        <div class="modal-action">
          <form method="dialog">
            <button class="btn btn-primary">
              <i class="fas fa-times mr-2"></i>
              Cerrar
            </button>
          </form>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>Cerrar</button>
      </form>
    `;
    
    document.body.appendChild(modalDiv);
    modalRespuestaJson = modalDiv;
    modalRespuestaJsonContent = document.getElementById('modal-respuesta-json-content');
  }
  
  // Llenar el contenido
  if (modalRespuestaJsonContent) {
    modalRespuestaJsonContent.textContent = JSON.stringify(data, null, 2);
  }
  
  // Mostrar el modal
  if (modalRespuestaJson) {
    console.log('Mostrando modal de respuesta');
    if (typeof modalRespuestaJson.showModal === 'function') {
      modalRespuestaJson.showModal();
    } else {
      modalRespuestaJson.setAttribute('open', '');
      modalRespuestaJson.classList.add('modal-open');
    }
    return true;
  }
  
  return false;
}

// Función para renderizar la tabla de parámetros dinámicamente
function renderizarTablaParametros(output, titulo, descripcion, tipoServicio) {
  console.log('Renderizando tabla de parámetros:', output);
  
  // Guardar valores en variables globales
  window.n8nTitulo = titulo;
  window.n8nDescripcion = descripcion;
  window.n8nTipoServicio = tipoServicio;
  
  // Ocultar spinner primero
  const spinnerContainer = document.getElementById('spinner-container');
  if (spinnerContainer) spinnerContainer.classList.add('hidden');
  
  // Ocultar el contenedor de "Datos Iniciales"
  const formCardContainer = document.querySelector('.flex.flex-col.items-center.justify-center.mt-8');
  if (formCardContainer) {
    formCardContainer.style.display = 'none';
  }
  
  // Guardar datos en sessionStorage
  try {
    sessionStorage.setItem('n8n_parametros', JSON.stringify(output.parametros));
    sessionStorage.setItem('n8n_actividad', output.actividad || '');
    sessionStorage.setItem('n8n_titulo', titulo);
    sessionStorage.setItem('n8n_descripcion', descripcion);
    sessionStorage.setItem('n8n_tipo_servicio', tipoServicio);
  } catch (error) {
    console.error('Error al guardar en sessionStorage:', error);
  }
  
  // Obtener el modal de parámetros
  const modalParametros = document.getElementById('modal-parametros-tecnicos');
  if (!modalParametros) {
    console.error('No se encontró el modal modal-parametros-tecnicos');
    mostrarModalJSON({error: 'No se encontró el modal de parámetros', output: output});
    return;
  }
  
  // Actualizar título del modal si hay actividad
  const modalTitulo = document.getElementById('modal-parametros-titulo');
  if (modalTitulo) {
    const actividad = output.actividad || '';
    modalTitulo.textContent = actividad ? `Parámetros Técnicos - ${actividad}` : 'Parámetros Técnicos';
  }
  
  // Obtener el tbody de la tabla
  const tableBody = document.getElementById('parametros-table-body');
  if (!tableBody) {
    console.error('No se encontró el tbody de la tabla');
    mostrarModalJSON({error: 'No se encontró el cuerpo de la tabla', output: output});
    return;
  }
  
  // Limpiar el tbody antes de llenarlo
  tableBody.innerHTML = '';
  
  // Escapar HTML para prevenir XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // Agregar filas de parámetros
  const parametros = output.parametros || [];
  parametros.forEach((parametro, index) => {
    const checked = parametro.check ? 'checked' : '';
    const unidadMedida = parametro.unidad_medida || '';
    
    const row = document.createElement('tr');
    row.className = 'parametro-row';
    row.setAttribute('data-index', index);
    
    row.innerHTML = `
      <td>
        <input 
          type="checkbox" 
          class="checkbox checkbox-primary parametro-checkbox" 
          data-parametro="${escapeHtml(parametro.parametro || '')}"
          data-valor="${escapeHtml(parametro.valor_recomendado || '')}"
          data-detalle="${escapeHtml(parametro.detalle || '')}"
          data-unidad="${escapeHtml(unidadMedida)}"
          id="param-${index}"
          ${checked}
        >
      </td>
      <td class="font-semibold">${escapeHtml(parametro.parametro || '')}</td>
      <td class="text-right">
        <input 
          type="text" 
          class="input input-bordered input-primary input-sm w-full valor-recomendado-input focus:input-primary text-right" 
          value="${escapeHtml(parametro.valor_recomendado || '')}"
          data-original-value="${escapeHtml(parametro.valor_recomendado || '')}"
        >
      </td>
      <td class="text-sm text-base-content/70 font-medium text-center">${escapeHtml(unidadMedida)}</td>
      <td class="text-sm text-base-content/70 leading-tight p-2 align-top" style="word-wrap: break-word; white-space: pre-wrap; min-width: 200px;">${escapeHtml(parametro.detalle || '')}</td>
    `;
    
    tableBody.appendChild(row);
  });
  
  // Agregar fila para nuevo parámetro
  const nuevaFilaRow = document.createElement('tr');
  nuevaFilaRow.id = 'nuevo-parametro-row';
  nuevaFilaRow.className = 'bg-base-200';
  nuevaFilaRow.innerHTML = `
    <td>
      <button class="btn btn-sm btn-success" id="agregar-parametro-btn" title="Agregar parámetro">
        <i class="fas fa-plus"></i>
      </button>
    </td>
    <td>
      <input 
        type="text" 
        class="input input-bordered input-sm w-full" 
        id="nuevo-parametro-nombre"
        placeholder="Nombre del parámetro"
      >
    </td>
    <td class="text-right">
      <input 
        type="text" 
        class="input input-bordered input-sm w-full text-right" 
        id="nuevo-parametro-valor"
        placeholder="Valor recomendado"
      >
    </td>
    <td class="text-center">
      <input 
        type="text" 
        class="input input-bordered input-sm w-full text-center" 
        id="nuevo-parametro-unidad"
        placeholder="Unidad de medida"
      >
    </td>
    <td>
      <input 
        type="text" 
        class="input input-bordered input-sm w-full" 
        id="nuevo-parametro-detalle"
        placeholder="Detalle (opcional)"
      >
    </td>
  `;
  tableBody.appendChild(nuevaFilaRow);
  
  // Cargar el script de manejo de parámetros
  setTimeout(() => {
    cargarScriptParametros();
  }, 100);
  
  // Mostrar el modal
  console.log('Mostrando modal de parámetros técnicos');
  if (typeof modalParametros.showModal === 'function') {
    modalParametros.showModal();
  } else {
    modalParametros.setAttribute('open', '');
    modalParametros.classList.add('modal-open');
  }
}

// Función para mostrar el formulario con observación
function mostrarFormularioConObservacion(apiResult, tituloOriginal, descripcionOriginal, tipoServicioOriginal) {
  console.log('Mostrando formulario con observación:', apiResult);
  
  // Obtener valores de la respuesta o usar los originales
  const titulo = apiResult.titulo || apiResult.titulo_actual || tituloOriginal || '';
  const descripcion = apiResult.descripcion || apiResult.descripcion_actual || descripcionOriginal || '';
  const tipoServicio = tipoServicioOriginal || '';
  const observacion = apiResult.observacion || apiResult.pregunta || '';
  
  // Ocultar spinner primero
    const spinnerContainer = document.getElementById('spinner-container');
  if (spinnerContainer) spinnerContainer.classList.add('hidden');
  
  // Obtener el contenedor del formulario (puede estar oculto)
  let formCardContainer = document.querySelector('.flex.flex-col.items-center.justify-center.mt-8');
  
  // Si no existe o está oculto, buscar en el contenedor principal
  if (!formCardContainer || formCardContainer.style.display === 'none') {
    // Buscar en el contenedor principal de contenido
    const contentContainer = document.querySelector('.flex.flex-col.items-center');
    if (contentContainer) {
      formCardContainer = contentContainer;
    } else {
      // Crear un nuevo contenedor si no existe
      const mainContainer = document.querySelector('div.flex.flex-col.items-center') || document.body;
      formCardContainer = document.createElement('div');
      formCardContainer.className = 'flex flex-col items-center justify-center mt-8 w-full';
      mainContainer.appendChild(formCardContainer);
    }
  }
  
  // Asegurarse de que el contenedor esté visible
  if (formCardContainer) {
    formCardContainer.style.display = 'flex';
  }
  
  console.log('Contenedor encontrado:', !!formCardContainer);
  
  // Generar HTML del formulario con observación
  const observacionHTML = observacion ? `
    <div class="alert alert-warning mb-4">
      <i class="fas fa-exclamation-triangle mr-2"></i>
      <div>
        <div class="font-semibold mb-1">Observación:</div>
        <div>${observacion.replace(/\n/g, '<br>')}</div>
      </div>
    </div>
  ` : '';
  
  let formHTML = `
    <div class="flex flex-col items-center justify-center mt-8 w-full max-w-5xl">
      <div class="card bg-base-100 shadow-2xl w-full hover:shadow-3xl transition-shadow">
        <div class="card-body p-8">
          <div class="mb-6">
            <h2 class="card-title text-2xl mb-2">
              <div class="flex items-center gap-4">
                <div class="badge badge-primary badge-lg w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg animate-pulse-glow">
                  1
                </div>
                <span class="text-primary">
                  <i class="fas fa-database mr-2"></i>
                  Datos Iniciales
                </span>
              </div>
            </h2>
            <p class="text-sm text-base-content/60 ml-14">Complete los datos para generar la especificación técnica</p>
          </div>
          
          ${observacionHTML}
          
          <form id="datos-generales-form" class="space-y-6">
            <!-- Título y Tipo de Servicio en una fila -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Título -->
              <div class="form-control w-full">
                <label class="label" for="titulo">
                  <span class="label-text font-semibold flex items-center gap-2">
                    <i class="fas fa-heading text-primary"></i>
                    Título
                  </span>
                  <span class="label-text-alt text-error font-bold">*</span>
                </label>
                <input 
                  type="text" 
                  name="titulo" 
                  id="titulo"
                  class="input input-bordered input-primary w-full focus:input-primary" 
                  placeholder="Ingrese el título"
                  value="${titulo.replace(/"/g, '&quot;')}"
                  required
                >
                <label class="label hidden" id="titulo-error-label">
                  <span class="label-text-alt text-error" id="titulo-error"></span>
                </label>
              </div>
              
              <!-- Tipo de Servicio -->
              <div class="form-control w-full">
                <label class="label" for="tipo_servicio">
                  <span class="label-text font-semibold flex items-center gap-2">
                    <i class="fas fa-cogs text-primary"></i>
                    Tipo de Servicio
                  </span>
                  <span class="label-text-alt text-error font-bold">*</span>
                </label>
                <select 
                  name="tipo_servicio" 
                  id="tipo_servicio"
                  class="select select-bordered select-primary w-full focus:select-primary" 
                  required
                >
                  <option value="">Seleccione un tipo de servicio</option>
                  <option value="Mecánico" ${tipoServicio === 'Mecánico' ? 'selected' : ''}>Mecánico</option>
                  <option value="Eléctrico" ${tipoServicio === 'Eléctrico' ? 'selected' : ''}>Eléctrico</option>
                  <option value="Instrumentación" ${tipoServicio === 'Instrumentación' ? 'selected' : ''}>Instrumentación</option>
                  <option value="SSMA (Seguridad, Salud y Medio Ambiente)" ${tipoServicio === 'SSMA (Seguridad, Salud y Medio Ambiente)' ? 'selected' : ''}>SSMA (Seguridad, Salud y Medio Ambiente)</option>
                  <option value="Infraestructura / Obras Civiles" ${tipoServicio === 'Infraestructura / Obras Civiles' ? 'selected' : ''}>Infraestructura / Obras Civiles (OOCC)</option>
                  <option value="Mantenimiento de Vehículos" ${tipoServicio === 'Mantenimiento de Vehículos' ? 'selected' : ''}>Mantenimiento de Vehículos</option>
                  <option value="Laboratorio y Aseguramiento de la Calidad" ${tipoServicio === 'Laboratorio y Aseguramiento de la Calidad' ? 'selected' : ''}>Laboratorio y Aseguramiento de la Calidad</option>
                  <option value="Logística y Distribución" ${tipoServicio === 'Logística y Distribución' ? 'selected' : ''}>Logística y Distribución</option>
                </select>
                <label class="label hidden" id="tipo-servicio-error-label">
                  <span class="label-text-alt text-error" id="tipo-servicio-error"></span>
                </label>
              </div>
            </div>

            <!-- Descripción -->
            <div class="form-control w-full">
              <label class="label" for="descripcion">
                <span class="label-text font-semibold flex items-center gap-2">
                  <i class="fas fa-align-left text-primary"></i>
                  Descripción
                </span>
                <span class="label-text-alt text-error font-bold">*</span>
              </label>
              <textarea 
                name="descripcion" 
                id="descripcion"
                class="textarea textarea-bordered textarea-primary w-full focus:textarea-primary" 
                rows="3"
                placeholder="Ingrese la descripción detallada..."
                required
              >${descripcion.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
              <label class="label hidden" id="descripcion-error-label">
                <span class="label-text-alt text-error" id="descripcion-error"></span>
              </label>
            </div>

            <!-- Botón de acción -->
            <div class="flex justify-end mt-8 pt-6 border-t border-base-300">
              <button type="button" id="btn-continuar-datos" class="btn btn-primary btn-lg">
                <span class="normal-text flex items-center gap-2">
                  <i class="fas fa-arrow-right"></i>
                  Continuar
                </span>
                <span class="loading loading-spinner loading-sm hidden"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;
  
  // Reemplazar el contenido del contenedor
  formCardContainer.innerHTML = formHTML;
  
  // Scroll al formulario
  setTimeout(() => {
    formCardContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

// NOTA: Las siguientes funciones han sido movidas a sus respectivos archivos de modal para mejor mantenimiento:
// - cargarScriptParametros() -> paso2_parametros.html
// - enviarTituloAjustado() -> paso3_titulo.html  
// - renderizarTablaActividades() -> paso4_actividades.html
// - cargarScriptActividades() -> paso4_actividades.html
</script>
{% endblock %}

