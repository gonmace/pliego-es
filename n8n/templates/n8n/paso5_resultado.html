{% extends 'n8n/pasos.html' %}
{% load static crispy_forms_tags tailwind_tags %}

{% block content %}
  {{ block.super }}
  
  <!-- Contenido del Paso 5: Resultado -->
  <div class="flex flex-col items-center justify-center mt-6">
    <div class="card w-full max-w-5xl bg-base-100 shadow-xl">
      <div id="resultContainer" class="mt-8 mx-auto rounded-lg shadow" style="display: none;">
        <div class="p-4 rounded-md">
          <article id="response-content" class="prose prose-slate prose-lg max-w-5xl px-20 pt-6">
          </article>
        </div>
      </div>

      <!-- Botones de navegación -->
      <div class="card-actions justify-end m-6">
        <button onclick="window.location.href='{% url 'n8n:pasos' %}'" class="btn btn-outline">
          <i class="fas fa-redo mr-2"></i>
          Generar Nueva
        </button>
        <button id="btnGuardar" onclick="guardarEspecificacion()" class="btn btn-primary btn-disabled" disabled>
          <i class="fas fa-save mr-2"></i>
          Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- Spinner de carga -->
  <div id="loadingSpinner" class="fixed inset-0 backdrop-blur-sm bg-base-300/10 flex items-center justify-center z-50" style="display: none;">
    <div class="flex flex-col items-center gap-4">
      <span class="loading loading-spinner loading-lg text-primary"></span>
      <p class="text-lg font-medium text-white">Cargando especificación...</p>
    </div>
  </div>
{% endblock %}

{% block js %}
  <script>
    const btnGuardar = document.getElementById('btnGuardar');
    window.__ultimoMarkdown = null;

    function setGuardarEnabled(enabled) {
      if (!btnGuardar) return;
      btnGuardar.disabled = !enabled;
      btnGuardar.classList.toggle('btn-disabled', !enabled);
    }

    // Función para mostrar/ocultar el spinner
    function toggleSpinner(show) {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.style.display = show ? 'flex' : 'none';
      }
    }

    // Función para obtener el token CSRF
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Función para guardar la especificación
    async function guardarEspecificacion() {
      if (!window.__ultimoMarkdown) {
        alert('No hay especificación para guardar.');
        return;
      }

      try {
        toggleSpinner(true);
        setGuardarEnabled(false);

        const response = await fetch('{% url "n8n:guardar_resultado" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            contenido: window.__ultimoMarkdown,
            especificacion_id: window.especificacionTecnicaId
          })
        });

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error(`Error del servidor (${response.status}): La respuesta no es JSON válido. Respuesta: ${text.substring(0, 200)}`);
        }

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || `Error del servidor (${response.status}): No se pudo guardar la especificación`);
        }
        
        if (!data.success) {
          throw new Error(data.error || 'No se pudo guardar la especificación');
        }

        // Redirigir a la página de éxito o mostrar mensaje
        if (data.redirect_url) {
          window.location.href = data.redirect_url;
        } else {
          alert('Especificación guardada exitosamente');
          window.location.href = '{% url "n8n:pasos" %}';
        }
      } catch (error) {
        console.error('Error al guardar:', error);
        alert('Error al guardar la especificación: ' + error.message);
        setGuardarEnabled(true);
        toggleSpinner(false);
      }
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', async function () {
      try {
        toggleSpinner(true);
        
        // Obtener el ID de la especificación técnica desde múltiples fuentes
        // 1. De la URL (parámetro GET)
        const urlParams = new URLSearchParams(window.location.search);
        let especificacionId = urlParams.get('especificacion_id');
        
        // 2. De sessionStorage si no está en la URL
        if (!especificacionId) {
          especificacionId = sessionStorage.getItem('especificacionTecnicaId');
        }
        
        // 3. De la variable global si está disponible
        if (!especificacionId && window.especificacionTecnicaId) {
          especificacionId = window.especificacionTecnicaId;
        }
        
        // Si aún no tenemos el ID, mostrar error
        if (!especificacionId) {
          throw new Error('No se pudo obtener el ID de la especificación técnica. Por favor, vuelva a iniciar el proceso.');
        }
        
        // Guardar en sessionStorage y variable global para futuras referencias
        sessionStorage.setItem('especificacionTecnicaId', especificacionId);
        window.especificacionTecnicaId = especificacionId;
        
        // Actualizar el ID en el breadcrumbs si existe el elemento
        const idDisplay = document.getElementById('especificacion-id-display');
        const idValue = document.getElementById('especificacion-id-value');
        if (idDisplay && idValue) {
          idValue.textContent = especificacionId;
          idDisplay.classList.remove('hidden');
        }
        
        // Obtener el resultado desde el servidor
        const url = '{% url "n8n:paso5_resultado" %}?especificacion_id=' + especificacionId;
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new TypeError("La respuesta no es JSON válido");
        }

        const resultado = await response.json();
        console.log('Respuesta del servidor:', resultado);

        if (resultado.success && resultado.markdown_html) {
          // Mostrar el resultado
          document.getElementById('response-content').innerHTML = resultado.markdown_html;
          document.getElementById('resultContainer').style.display = 'block';
          window.__ultimoMarkdown = resultado.raw_markdown || resultado.markdown_html;
          toggleSpinner(false);
          setGuardarEnabled(true);
        } else {
          throw new Error(resultado.error || 'No se encontró el resultado de la especificación');
        }
      } catch (error) {
        console.error('Error:', error);
        toggleSpinner(false);
        alert('Error al cargar el resultado: ' + error.message);
        // Redirigir al inicio si hay error
        window.location.href = '{% url "n8n:pasos" %}';
      }
    });
  </script>
{% endblock %}

